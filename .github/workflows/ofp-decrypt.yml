name: OFP Decrypter by Area69Labs

on:
  workflow_dispatch:
    inputs:
      ofp_link:
        description: 'OFP Firmaware Link'
        required: true
      bigfile:
        description: 'Set if your ofp file is more than 8GB. Setting to yes will take more time.'
        required: false
        default: 'NO'             
        
env:
  OFP_LINK: ${{ github.event.inputs.ofp_link }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: CleanUp Enviroment
        if: ${{ github.event.inputs.bigfile }} == 'YES'     
        uses: rokibhasansagar/slimhub_actions@main

      - name: Download OFP Firmware
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y megatools wget
          echo "Downloading from MEGA..."

          # Download directly to current directory instead of /tmp
          megadl "${{ github.event.inputs.ofp_link }}" --path=.

          # Find the downloaded file in current directory
          DOWNLOADED_FILE=$(ls -1 *.ofp *.OFP 2>/dev/null | head -n 1)

          if [ -z "$DOWNLOADED_FILE" ]; then
           echo "Error: No OFP file found after download"
           ls -lah
           exit 1
          fi

          echo "Downloaded file: $DOWNLOADED_FILE"

          # Rename to firmware.ofp if needed
          if [ "$DOWNLOADED_FILE" != "firmware.ofp" ]; then
           mv "$DOWNLOADED_FILE" firmware.ofp
          fi

          ls -lh firmware.ofp

          # Verify file size
          FILE_SIZE=$(stat -c%s firmware.ofp)
          echo "File size: ${FILE_SIZE} bytes"

          if [ "$FILE_SIZE" -lt 1000000000 ]; then
           echo "Error: Downloaded file is too small (${FILE_SIZE} bytes)"
           exit 1
          fi
          
          echo "Download successful: $(du -h firmware.ofp | cut -f1)"
          OFPFILE="firmware.ofp"
          echo "OFP_FILE=${OFPFILE}" >> $GITHUB_ENV
          OFPNAME=$(basename ${OFPFILE} .ofp)
          echo "OFP_NAME=${OFPNAME}" >> $GITHUB_ENV

      - name: Prepare Decrypter and Decrypt OFP
        run: |
          sudo apt-get update -qqy
          sudo apt-get install -qqy openssl rsync sshpass python3-pip python3-pycryptodome unzip
          
          # Clone the decrypt tool
          git clone https://github.com/bkerler/oppo_decrypt.git --depth=1

          # Check file info
          echo "=== File Information ==="
          ls -lh firmware.ofp
          file firmware.ofp

          # Try extracting as a simple archive first (some OFPs are just zips)
          echo "=== Attempting direct extraction ==="
          mkdir -p out
          unzip -l firmware.ofp 2>/dev/null || echo "Not a ZIP file"
          
          # Try QC decryption with verbose output
          echo "=== Trying QC Decryption ==="
          python3 ./oppo_decrypt/ofp_qc_extract.py firmware.ofp out || {
           echo "QC decryption failed, trying MTK..."
          }

          # Check if we got the files
          if [[ ! -f out/super.img && ! -f out/system.img ]]; then
           echo "=== Trying MTK Decryption ==="
           python3 ./oppo_decrypt/ofp_mtk_decrypt.py firmware.ofp out || {
            echo "MTK decryption also failed"
           }
          fi

          # Final check
          echo "=== Checking extracted files ==="
          ls -lah out/ || true

          if [[ ! -f out/super.img && ! -f out/system.img ]]; then
           echo "=== DECRYPTION FAILED ==="
           echo "This OFP may use unsupported encryption or be corrupted"
           echo "File details:"
           hexdump -C firmware.ofp | head -20
           exit 1
          fi

          echo "=== Decryption successful! ===
          ls -lh out/
           
      - name: Compress & Upload Decrypted Zip
        run: |
          zip -r9 Decrypted."${OFPNAME}".zip out/
          echo "exit" | sshpass -p ${{ secrets.SFPASS }} ssh -tto StrictHostKeyChecking=no ${{ secrets.SFUSER }}@shell.sourceforge.net create
          rsync -arvPz --rsh="sshpass -p ${{ secrets.SFPASS }} ssh -l ${{ secrets.SFUSER }}" Decrypted."${OFPNAME}".zip ${{ secrets.SFUSER }}@shell.sourceforge.net:/home/frs/project/${{ secrets.SFDIR }}/"$OFP_NAME"/
          echo -e "\nGet your file at https://sourceforge.net/projects/${{ secrets.SFDIR }}/$OFP_NAME/Decrypted.${OFPNAME}.zip\n\n"
